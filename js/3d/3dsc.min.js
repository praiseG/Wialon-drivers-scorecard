var callbacks={},errorCodes={1:"Invalid session",2:"Invalid service name",3:"Invalid result",4:"Invalid input",5:"Error performing request",6:"Unknown error",7:"Access denied",8:"Invalid user name or password",9:"Authorization server is unavailable",10:"Reached limit of concurrent requests",1001:"No messages for selected interval",1003:"Only one request is allowed at the moment",1004:"Limit of messages has been exceeded",1005:"Execution time has exceeded the limit",1011:"Your IP has changed or session has expired"},timeToSeconds=function(e){if(e){var t=e.split(":");return 3600*+t[0]+60*+t[1]+ +t[2]}},strToDate=function(e,t){if(!e)return null;var o=e.split(".");return t?moment(o[2]+"-"+o[1]+"-"+o[0],"YYYY-MM-DD").endOf("day").format():moment(o[2]+"-"+o[1]+"-"+o[0],"YYYY-MM-DD").startOf("day").format()},showPickerFields=function(){var e=Cookies.getJSON("rDates");console.log(e);var t=moment(e.fDate).format("DD.MM.YYYY"),o=moment(e.tDate).format("DD.MM.YYYY");$("#fromDate").val(t),$("#toDate").val(o),$("#fromDate").datepicker({dateFormat:"dd.mm.yy",maxDate:"+1d"}),$("#toDate").datepicker({dateFormat:"dd.mm.yy",maxDate:"+1d"}),$(".picker-display").hide(),$(".picker-fields").show()},showPickerDisplays=function(e,t){console.log(Cookies.getJSON("rDates")),"wDate"==e||"mDate"==e?$("#selDate").addClass("form-control-sel"):$("#selDate").removeClass("form-control-sel"),$("#selDate").val(t),$(".picker-fields").hide(),$(".picker-display").show()},setCookies=function(e,t){ck=Cookies.get(e),null!=ck&&Cookies.remove(e),Cookies.set(e,t)},getDates=function(e){if(setCookies("period",e),"tDate"==e){var t=moment().startOf("day"),o=moment().endOf("day"),a=t.format("DD.MM.YYYY");setCookies("rDates",{fDate:t.format(),tDate:o.format()}),setCookies("selDates",a),showPickerDisplays(e,a)}else if("yDate"==e){t=moment().subtract(1,"days").startOf("day"),o=moment().subtract(1,"days").endOf("day"),a=t.format("DD.MM.YYYY");setCookies("rDates",{fDate:t.format(),tDate:o.format()}),setCookies("selDates",a),showPickerDisplays(e,a)}else if("wDate"==e){t=moment().subtract(1,"weeks").startOf("week"),o=moment().subtract(1,"weeks").endOf("week"),a=t.format("DD.MM.YYYY")+"-"+o.format("DD.MM.YYYY");setCookies("rDates",{fDate:t.format(),tDate:o.format()}),setCookies("selDates",a),showPickerDisplays(e,a)}else if("mDate"==e){t=moment().subtract(1,"months").startOf("month"),o=moment().subtract(1,"months").endOf("month"),a=t.format("DD.MM.YYYY")+"-"+o.format("DD.MM.YYYY");setCookies("rDates",{fDate:t.format(),tDate:o.format()}),setCookies("selDates",a),showPickerDisplays(e,a)}else"cDate"==e&&(showPickerFields(),Cookies.remove("selDates"))},getNextDate=function(){var e=$("#dTargets label.active"),t=e.children("input").prop("id");if("yDate"==t){var o=Cookies.getJSON("rDates"),a=moment(o.fDate).add(1,"days"),r=moment(o.tDate).add(1,"days"),s=moment().startOf("day"),n=a.format("DD.MM.YYYY");setCookies("rDates",{fDate:a.format(),tDate:r.format()}),setCookies("selDates",n),showPickerDisplays(t,n),console.log("min = today;"+a+"="+s),a.isSame(s)&&(e.removeClass("active"),$("#tDate").parent("label").addClass("active"))}else if("wDate"==t){o=Cookies.getJSON("rDates");var l=moment(o.fDate).add(1,"weeks"),i=moment(o.tDate).add(1,"weeks"),c=moment().endOf("day"),m=moment().startOf("day");if(console.log("tf tt:"+l.format()+" "+i.format()),l.isBefore(m)||l.isSame(m)){a=l,r=i.isAfter(c)?c:i,n=a.format("DD.MM.YYYY")+"-"+r.format("DD.MM.YYYY");setCookies("rDates",{fDate:a.format(),tDate:r.format()}),setCookies("selDates",n),showPickerDisplays(t,n)}}else if("mDate"==t){o=Cookies.getJSON("rDates"),l=moment(o.fDate).add(1,"months").startOf("month"),i=moment(o.tDate).add(1,"months").endOf("month"),c=moment().endOf("day"),m=moment().startOf("day");if(console.log("tf tt:"+l.format()+" "+i.format()),l.isBefore(m)||l.isSame(m)){a=l,r=i.isAfter(c)?c:i,n=a.format("DD.MM.YYYY")+"-"+r.format("DD.MM.YYYY");setCookies("rDates",{fDate:a.format(),tDate:r.format()}),setCookies("selDates",n),showPickerDisplays(t,n)}}console.log(t)},getPrevDate=function(){var e=$("#dTargets label.active"),t=e.children("input").prop("id");if("tDate"==t){var o=moment().subtract(1,"days").startOf("day"),a=moment().subtract(1,"days").endOf("day"),r=o.format("DD.MM.YYYY");setCookies("rDates",{fDate:o.format(),tDate:a.format()}),setCookies("selDates",r),showPickerDisplays(t,r),e.removeClass("active"),$("#yDate").parent("label").addClass("active")}else if("yDate"==t){var s=Cookies.getJSON("rDates");o=moment(s.fDate).subtract(1,"days"),a=moment(s.tDate).subtract(1,"days"),r=o.format("DD.MM.YYYY");setCookies("rDates",{fDate:o.format(),tDate:a.format()}),setCookies("selDates",r),showPickerDisplays(t,r),console.log("min to max "+o+" "+a)}else if("wDate"==t){s=Cookies.getJSON("rDates"),o=moment(s.fDate).subtract(1,"weeks").startOf("week"),a=moment(s.fDate).subtract(1,"weeks").endOf("week"),r=o.format("DD.MM.YYYY")+"-"+a.format("DD.MM.YYYY");setCookies("rDates",{fDate:o.format(),tDate:a.format()}),setCookies("selDates",r),showPickerDisplays(t,r),console.log("min to max "+o+" "+a)}else if("mDate"==t){s=Cookies.getJSON("rDates"),o=moment(s.fDate).subtract(1,"months").startOf("month"),a=moment(s.fDate).subtract(1,"months").endOf("month"),r=o.format("DD.MM.YYYY")+"-"+a.format("DD.MM.YYYY");setCookies("rDates",{fDate:o.format(),tDate:a.format()}),setCookies("selDates",r),showPickerDisplays(t,r),console.log("min to max "+o+" "+a)}console.log(t)},getDateInterval=function(){var e=Cookies.getJSON("rDates");if(!e)return null;var t=moment(e.fDate).unix(),o=moment(e.tDate).unix();return console.log("intervals:fromDate : toDate ="+t+" ===="+o),[t,o]};function ie(){return-1!=navigator.appVersion.indexOf("MSIE 6")||-1!=navigator.appVersion.indexOf("MSIE 7")||-1!=navigator.appVersion.indexOf("MSIE 8")}var execCallback=function(e){callbacks[e]&&callbacks[e].call()};function wrapCallback(e){var t=(new Date).getTime();return callbacks[t]=e,t}function getHtmlVar(e){if(!e)return null;for(var t=decodeURIComponent(document.location.search.substr(1)).split("&"),o=0;o<t.length;o++){var a=t[o].split("=");if(a[0]==e)return a.splice(0,1),a.join("=")}return null}function loadScript(e,t){var o=document.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("charset","UTF-8"),o.setAttribute("src",e),t&&"function"==typeof t&&(wrapCallback(t),ie()?o.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||t()}:o.setAttribute("onLoad","execCallback("+wrapCallback(t)+")")),document.getElementsByTagName("head")[0].appendChild(o)}var getTransporterFromUnitName=function(e){if(e)return start=e.indexOf("("),end=e.indexOf(")"),transporter=e.slice(start+1,end),unit_license=e.slice(0,start),{transporter:transporter,unit_license:unit_license}},fetchUnits=function(e){var t=wialon.core.Session.getInstance();t.loadLibrary("itemIcon"),t.loadLibrary("itemCustomFields"),t.loadLibrary("itemProfileFields"),t.loadLibrary("unitDriveRankSettings"),t.loadLibrary("unitEvents"),t.loadLibrary("unitTripDetector");var o=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Unit.dataFlag.lastMessage,wialon.item.Item.dataFlag.customFields,wialon.item.Item.dataFlag.adminFields,wialon.item.Item.dataFlag.customProps,wialon.item.Item.dataFlag.guid,256,8388608,131072,524288,8192,4096);t.updateDataFlags([{type:"type",data:"avl_unit",flags:o,mode:0},{type:"type",data:"avl_unit_group",flags:o,mode:0}],function(o){if(console.log("codefu "+o),o)console.log(wialon.core.Errors.getErrorText(o));else{var a=t.getItems("avl_unit");if((a=wialon.util.Helper.filterItems(a,wialon.item.Item.accessFlag.execReports))&&a.length){console.log("units hereee orig"),console.log(a);var r=$("#vlr-tbl").dataTable().api(),s=[],n="";if(e){var l=t.getItem(e);if(console.log("selected group item "),console.log(l),!l)return void console.log("Selected Unit Groups not found");var i=l.getUnits();l.getName();i.length?(console.log("looping through group units"),_.each(a,function(e,t,o){var a=e.getId();_.contains(i,a)&&s.push(e)})):r.row(0).remove().draw()}else{var c=t.getItems("avl_unit_group");if(!c||!c.length)return void console.log("No Unit Groups found");n+='<option class="select-option" id="" selected>All Units</option>',_.each(c,function(e,t,o){var r=e.getName();if("Camera Units"!=r){var l=e.getId();e.getUnits();n+='<option class="select-option" id="'+l+'">'+r+"</option>"}s=a})}if(n&&($("#groups-list").empty(),$("#groups-list").html(n)),s.length){for(var m=0,d=0;m<s.length;m++,d++){var g=s[m],u=g.getName();if(u.endsWith("(Cam)")||u.endsWith("(Eco Driving)")||u.startsWith("inspector.wiatag"))d--;else{g.getTripsHistory()&&(console.log("trips history here"),console.log(g.getTripsHistory()),console.log("trips hist here")),g.getCurrentTrip()&&(console.log("trips here"),console.log(g.getCurrentTrip()),console.log("trips here"));var p=g.getIgnitionHistory(1,1527973200,1530565200);console.log("ignition history==="),console.log(p);var f="unknown",v="unknown",D="unknown",h="unknown",w="unknown",y="unknown",b=_.values(g.getCustomFields());_.size(b)>0&&_.each(b,function(e,t,o){"Site Name"==e.n?f=e.v:"Site ID"==e.n&&(v=e.v)});var k=_.values(g.getProfileFields());_.size(k)>0&&_.each(k,function(e,t,o){"year"==e.n?D=e.v:"brand"==e.n?h=e.v:"model"==e.n?w=e.v:"vin"==e.n&&(y=e.v)});var I="unknown",Y=g.getPosition();Y&&(I=wialon.util.DateTime.formatTime(Y.t));var C=getTransporterFromUnitName(u),S=C.transporter,F=C.unit_license,M={id:d+1,icon_url:g.getIconUrl(32),transporter_id:S,license_number:F,vin:y,year_mke_model:D+"/"+h+"/"+w,site_name:f,site_id:v,ivms_id:g.getUniqueId(),last_gps_conn:I,last_trip_dt:I},T=_.template($("#vlr-data").html());r.row.add($(T({vhl:M})))}}r.row(0).remove().draw()}}else console.log("Units not found")}})},fetchDrivers=function(){var e=wialon.core.Session.getInstance();e.loadLibrary("resourceDrivers"),e.loadLibrary("resourceDriverUnits"),e.loadLibrary("itemDriver"),e.loadLibrary("itemCustomFields");var t=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Resource.dataFlag.drivers,wialon.item.Resource.dataFlag.driverUnits,wialon.item.Item.dataFlag.customFields,16384);e.updateDataFlags([{type:"type",data:"avl_resource",flags:t,mode:0},{type:"type",data:"avl_unit",flags:t,mode:0}],function(t){if(t)console.log(wialon.core.Errors.getErrorText(t));else{var o=e.getItems("avl_resource");if(console.log("***************resources**********"),console.log(o),console.log("***************resources**********"),o&&o.length){for(var a=$("#dlr-tbl").dataTable().api(),r=0;r<o.length;r++){var s=o[r],n=s.getName(),l=_.values(s.getDrivers());if(console.log("res: "+n),console.log("reports"),_.size(l)>0)for(var i=0;i<l.length;i++){var c=l[i],m=c.n;c.id;console.log("--------dr-------------------"),console.log(c);var d="unknown",g="unknown",u="unknown",p="unknown",f="unknown",v="N/A";if(c.bu){console.log("driver Units");var D=e.getItem(c.bu);v=getTransporterFromUnitName(D.getName()).transporter,console.log(c.bu),console.log(D),console.log("Units after")}var h=c.jp;_.size(h)>0&&(_.has(h,"Site Name")&&(d=h["Site Name"]),_.has(h,"IVMS ID")&&(u=h["IVMS ID"]),_.has(h,"Site ID")&&(g=h["Site ID"]),_.has(h,"License ID")&&(p=h["License ID"]),_.has(h,"License Expiry")&&(f=h["License Expiry"]),console.log("site_name in:"+d)),console.log("site_name out:"+d);var w={id:i+1,icon_url:null,transporter_id:v,name:m,driver_id:u,driver_license:p,site_name:d,site_id:g,license_expiry:f},y=_.template($("#dlr-data").html());a.row.add($(y({drv:w})))}}a.row(0).remove().draw()}else console.log("No Resources found")}})},loadGroupScoreCard=function(e,t,o){if(console.log("inside group report"),console.log("res - gid :"+e+" "+t),e&&t&&o){console.log(o),wialon.core.Session.getInstance().loadLibrary("resourceReports");var a=$("#dsc-tbl").dataTable().api(),r=1,s=getDateInterval(),n=s[1],l=s[0];console.log("intervals :"+n+" "+l),console.log("configs here"),console.log(e),console.log(t),console.log(l),console.log(n);var i=[{svc:"report/exec_report",params:{reportResourceId:e,reportTemplateId:49,reportObjectId:t,reportObjectSecId:0,interval:{flags:0,from:l,to:n}}},{svc:"report/select_result_rows",params:{tableIndex:0,config:{type:"range",data:{from:0,to:65535,level:4,rawValues:0}}}},{svc:"report/select_result_rows",params:{tableIndex:1,config:{type:"range",data:{from:0,to:65535,level:4,rawValues:0}}}},{svc:"report/select_result_rows",params:{tableIndex:2,config:{type:"range",data:{from:0,to:65535,level:4,rawValues:0}}}},{svc:"report/cleanup_result",params:{}}];wialon.core.Remote.getInstance().remoteCall("core/batch",i,function(e,t){if(console.log(e),console.log(t),0===e&&t&&t.length&&!("error"in t[0])&&"reportResult"in t[0]&&t[0].reportResult.tables.length>0){console.log("report successful"),console.log(o);for(var s=0;s<o.length;s++){var n,l,i=o[s],c=0,m=0,d="unknown",g="unknown",u="00:00:00",p=0,f=0,v=0,D=0,h=0,w=0,y=null,b=0;uf_name=i.getName();var k=getTransporterFromUnitName(uf_name);l=k.transporter,n=k.unit_license;var I=_.values(i.getCustomFields());_.size(I)>0&&_.each(I,function(e,t,o){"Site Name"==e.n&&(g=e.v)}),r_tables=t[0].reportResult.tables;for(var Y=0;Y<r_tables.length;Y++)if("unit_group_ecodriving"!=r_tables[Y].name||"error"in t[Y+1])if("unit_group_speedings"!=r_tables[Y].name||"error"in t[Y+1]){if("unit_group_trips"==r_tables[Y].name&&!("error"in t[Y+1])){var C=t[Y+1];for(F=0;F<C.length;F++){if(C[F].c[0]==uf_name)b=C[F].c[1].split(" ")[0],console.log("Total Mileage : "+b),"unknown"==d&&C[F].c[6]&&(d=C[F].c[6])}}}else for(var S=t[Y+1],F=0;F<S.length;F++)S[F].c[0]==uf_name&&(console.log("uf_name="+uf_name),u=S[F].c[1],f=timeToSeconds(u),c+=p=parseInt(f/60),"unknown"==d&&S[F].c[2]&&(d=S[F].c[2]));else for(var M=t[Y+1],F=0;F<M.length;F++)if(M[F].c[0]==uf_name){console.log("uf_name="+uf_name);var T=M[F].r;console.log(T);for(var x=0;x<T.length;x++)"Harsh Acceleration"==T[x].c[1]?(v+=parseInt(T[x].c[2]),D+=parseInt(T[x].c[3]),c+=parseInt(D)):"Harsh Braking"==T[x].c[1]&&(h+=parseInt(T[x].c[2]),w+=parseInt(T[x].c[3]),c+=parseInt(w)),"unknown"==d&&T[x].c[4]&&(d=T[x].c[4])}if((0!=v||0!=h||0!=f)&&0!=b){0<=(m=Math.round(c/b*100))&&m<=2?y="green":2<m&&m<=5?y="yellow":m>5&&(y="red"),console.log("ovs count :"+u),console.log("ovs pnalty :"+p),console.log("hacc count :"+v),console.log("hacc pnalty :"+D),console.log("hbrk count :"+h),console.log("hbrk pnalty :"+w),console.log("total pnalty :"+c);var N={id:r++,s_color:y,transporter_id:l,drv_name:d,drv_lic:"unknown",tot_mileage:b.toLocaleString("en"),vehicle_license:n,site_name:g,hbrk_penalty:w,hbrk_occur:h,hacc_penalty:D,hacc_occur:v,ovs_penlty:p,ovs_duration:u,drvtime_penalty:0,drvtime_mins:0,resting_penalty:0,score:m},O=_.template($("#dsc-data").html());a.row.add($(O({dsc:N})))}}a.row(0).remove().draw()}else alert(errorCodes[e])})}else console.log("no resource or ugidor units")},fetchScores=function(e,t){var o=wialon.core.Session.getInstance(),a=wialon.item.Item.dataFlag.base|wialon.item.Resource.dataFlag.reports,r=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Unit.dataFlag.lastMessage,wialon.item.Item.dataFlag.customFields,wialon.item.Item.dataFlag.adminFields,wialon.item.Item.dataFlag.customProps,wialon.item.Item.dataFlag.guid,256,8388608,131072,524288,8192);o.loadLibrary("resourceReports"),o.loadLibrary("itemCustomFields"),o.loadLibrary("itemProfileFields"),o.updateDataFlags([{type:"type",data:"avl_resource",flags:a,mode:0},{type:"type",data:"avl_unit",flags:r,mode:0},{type:"type",data:"avl_unit_group",flags:r,mode:0}],function(a){if(a)console.log(wialon.core.Errors.getErrorText(a));else{var r,s=o.getItems("avl_resource"),n=o.getItems("avl_unit"),l="",i=null,c=$("#units-tbl").dataTable().api(),m=!1,d=[];if(n&&n.length)if(s&&s.length){if(r=s[0].getId(),console.log("units"),console.log(n),console.log("group selected :"+e),console.log("a_units outside group loop"),console.log(d),d=[],e){console.log("a_units inside selected group"),console.log(d);var g=o.getItem(e);if(console.log("selected group item "),console.log(g),!g)return void console.log("Selected Unit Groups not found");i=e;var u=g.getUnits();g.getName();console.log("looping through group units"),_.each(n,function(e,t,o){var a=e.getId();_.contains(u,a)&&d.push(e)})}else{var p=o.getItems("avl_unit_group");if(!p||!p.length)return void console.log("No Unit Groups found");console.log("unit_grps here"),console.log(p),_.each(p,function(e,t,o){var a=e.getName(),r=e.getUnits();if("Camera Units"!=a&&r.length){var s=e.getId();".All Units (LH UG)"==a?(i=s,l+='<option class="select-option" id="'+s+'" selected>'+a+"</option>",_.each(n,function(e,t,o){var a=e.getId();_.contains(r,a)&&d.push(e)})):l+='<option class="select-option" id="'+s+'">'+a+"</option>"}})}l&&($("#groups-list").empty(),$("#groups-list").html(l)),d.length&&!t&&(console.log("loading units html"),_.each(d,function(e,t,o){var a=e.getName();if(!a.endsWith("(Cam)")&&!a.endsWith("(Eco Driving)")&&!a.startsWith("inspector.wiatag")){var r=""+e.getId(),s=_.template($("#u-list-data").html());c.row.add($(s({unt:{uid:r,uname:a}}))),m||(m=!0),c.draw()}}),m&&(c.row(0).remove().draw(),m=!1)),console.log("loding report now"),loadGroupScoreCard(r,i,d)}else console.log("No Resources found");else console.log("No Units found")}})},getDriverScoreFactors=function(){console.log("in Driver Score Card");var e=wialon.core.Session.getInstance();e.loadLibrary("itemIcon"),e.loadLibrary("itemCustomFields"),e.loadLibrary("itemProfileFields"),e.loadLibrary("unitDriveRankSettings"),e.loadLibrary("unitEvents"),e.loadLibrary("unitTripDetector");var t=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Unit.dataFlag.lastMessage,wialon.item.Item.dataFlag.customFields,wialon.item.Item.dataFlag.adminFields,wialon.item.Item.dataFlag.customProps,wialon.item.Item.dataFlag.guid,256,8388608,131072,524288,8192),o=getDateInterval();e.updateDataFlags([{type:"type",data:"avl_unit",flags:t,mode:0}],function(t){if(console.log("codefu "+t),t)console.log(wialon.core.Errors.getErrorText(t));else{var a=e.getItems("avl_unit");if((a=wialon.util.Helper.filterItems(a,wialon.item.Item.accessFlag.execReports))&&a.length){console.log(a);var r=$("#dsc-tbl").dataTable().api();e.getCurrUser().getAccountId();15452548;var s=function(e){if(console.log("inside ca scores"),e<a.length){var t=a[e],n=t.getName();if(console.log("unit ========================="+n),n.endsWith("(Cam)"))s(e+1);else{var l=getTransporterFromUnitName(n),i=l.transporter,c=l.unit_license,m=(t.getMileageCounter(),t.getId()),d=o[1],g=o[0];console.log("t_to :"+d),console.log("t_from :"+g);var u=0,p=0,f="unknown",v="unknown",D="unknown",h="00:00:00",w=0,y=0,b=0,k=0,I=0,Y=null,C=0,S=_.values(t.getCustomFields());_.size(S)>0&&_.each(S,function(e,t,o){"Site Name"==e.n?D=e.v:"Driver License ID"==e.n&&(v=e.v)});var F=[{svc:"report/exec_report",params:{reportResourceId:15452548,reportTemplateId:48,reportObjectId:m,reportObjectSecId:0,interval:{flags:0,from:g,to:d}}},{svc:"report/select_result_rows",params:{tableIndex:0,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/select_result_rows",params:{tableIndex:1,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/select_result_rows",params:{tableIndex:2,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/cleanup_result",params:{}}];wialon.core.Remote.getInstance().remoteCall("core/batch",F,function(t,o){if(console.log("closure id*******"+e),console.log("code remote: "+t),console.log(o),0===t&&o&&o.length&&!("error"in o[0])&&"reportResult"in o[0]&&o[0].reportResult.tables.length>0){console.log("report successful see obj below"),console.log(o);for(var a=o[0].reportResult.tables,n=0;n<a.length;n++)if("unit_ecodriving"!=a[n].name||"error"in o[n+1])if("unit_speedings"!=a[n].name||"error"in o[n+1]){if("unit_trips"==a[n].name&&!("error"in o[n+1])){var l=a[n].total[0].split(" ");C=l[0],console.log("Total Mileage : "+C)}}else{for(var m=o[n+1],d=0;d<m.length;d++)if("unknown"==f&&m[d].c[1].t){f=m[d].c[1].t;break}h=a[n].total[0];var g=timeToSeconds(h);w+=parseInt(g/60),u+=w,console.log("Speeding penalty total "+u)}else{for(var S=o[n+1],F=0;F<S.length;F++){var M=S[F].c[0].t;"Harsh Acceleration"==M?(y=S[F].c[2].t,b=S[F].c[1].t,u+=parseInt(b)):"Harsh Braking"==M&&(k=S[F].c[2].t,I=S[F].c[1].t,u+=parseInt(I)),"unknown"==f&&S[F].c[3].t&&(f=m[F].c[3].t)}console.log("eco driving penalty total "+u)}0<=(p=Math.round(u/C*100))&&p<=2?Y="green":2<p&&p<=5?Y="yellow":p>5&&(Y="red"),console.log("ovs count :"+h),console.log("ovs pnalty :"+w),console.log("hacc count :"+y),console.log("hacc pnalty :"+b),console.log("hbrk count :"+k),console.log("hbrk pnalty :"+I),console.log("total pnalty :"+u),console.log("s_color ;"+Y);var T={id:e+1,s_color:Y,transporter_id:i,drv_name:f,vehicle_license:c,drv_lic:v,tot_mileage:C.toLocaleString("en"),site_name:D,hbrk_penalty:I,hbrk_occur:k,hacc_penalty:b,hacc_occur:y,ovs_penlty:w.toLocaleString("en"),ovs_duration:h,drvtime_penalty:0,drvtime_mins:0,resting_penalty:0,score:p},x=_.template($("#dsc-data").html());r.row.add($(x({dsc:T}))),0==e&&r.row(0).remove(),r.draw()}s(e+1)})}}};s(0)}else console.log("Units not found")}})},vlrReport=function(e){var t=_.template($("#vlr-cols").html());$(".date-displays").hide(),$("#unit-groups").show(),$("#rpt-table, #unit-list, #unit-scores").empty(),$("#rpt-table").html(t),$("#vlr-tbl").DataTable({pageLength:12,language:{emptyTable:"No Units Found"},dom:"Bfrtip",buttons:["csv",{extend:"excelHtml5",title:"Vehicles List Report"},"pdf","print"]}),fetchUnits(e)},dlrReport=function(){var e=_.template($("#dlr-cols").html());$(".date-displays").hide(),$("#unit-groups").hide(),$("#rpt-table, #unit-list, #unit-scores").empty(),$("#rpt-table").html(e),$("#dlr-tbl").DataTable({pageLength:12,dom:"Bfrtip",buttons:["csv",{extend:"excelHtml5",title:"Drivers List Report"},"pdf","print"]}),fetchDrivers()},dscReport=function(e,t){var o=_.template($("#dsc-cols").html());if($(".date-displays").show(),$(".picker-fields").hide(),$("#unit-groups").show(),$("#rpt-table").empty(),$("#unit-score").empty(),!t){var a=_.template($("#u-list-cols").html());$("#unit-list").empty(),$("#unit-list").html(a),$("#units-tbl").DataTable({scrollY:"350px",scrollCollapse:!0,paging:!1})}$("#unit-scores").html(o),$("#dsc-tbl").DataTable({language:{emptyTable:"No data available for selected interval"},dom:"Bfrtip",buttons:["csv",{extend:"excelHtml5",title:"Drivers Score Card"},"pdf","print"]}),fetchScores(e,t)},loadReportTemplate=function(e){console.log(e),"t-dlr"==e?dlrReport():"t-vlr"==e?vlrReport():"t-dsc"==e&&dscReport()},loadActiveReport=function(){var e=Cookies.get("sTemp"),t=parseInt($("#groups-list").find(":selected").prop("id"));console.log("selected report:"+e),console.log(t),"t-dsc"==e&&dscReport(t,!0)},login=function(e){if(console.log("Code: "+e),e)alert("Login Error");else{var t=wialon.core.Session.getInstance().getCurrUser().getName();document.getElementById("username").innerHTML=t,window.setTimeout(function(){$("#rTemplates").val("Drivers_Score_Card").trigger("change")},2e3),window.onbeforeunload=function(){wialon.core.Session.getInstance().logout()}}},initSdk=function(){console.log("Initializing SDK");var e=getHtmlVar("baseUrl")||getHtmlVar("HostUrl");if(console.log("url: "+e),e){var t=getHtmlVar("user")||"",o=getHtmlVar("sid"),a=getHtmlVar("authHash");wialon.core.Session.getInstance().initSession(e),a?(console.log("logging in with authHash"),wialon.core.Session.getInstance().loginAuthHash(a,login)):(console.log("logging in with sid"),wialon.core.Session.getInstance().duplicate(o,t,!0,login))}},onLoad=function(){loadScript("https://hst-api.wialon.com/wsdk/script/wialon.js",initSdk)};$(document).ready(function(){moment.tz.setDefault("Africa/Kampala");var e=$(".active").children("input").prop("id");getDates(e),$("#dTargets label").on("click",function(){var e=$(this).children("input").prop("id");getDates(e)}),$("#rTemplates").change(function(){var e=$(this).find(":selected"),t=e.text(),o=e.prop("id");$("#reportTitle").text(t),setCookies("sTemp",o),loadReportTemplate(o)}),$("#groups-list").change(function(){var e=parseInt($(this).find(":selected").prop("id"));console.log("gid after parse"),console.log(e);var t=$("#rTemplates").find(":selected").prop("value");"Drivers_Score_Card"==t?dscReport(e):"Vehicles_List_Report"==t&&vlrReport(e)}),$("#cusBtn").click(function(){var e=$("#fromDate").val(),t=$("#toDate").val();e&&t||alert("Select fromDate and toDate");var o=strToDate(e),a=strToDate(t,!0);setCookies("rDates",{fDate:o,tDate:a}),console.log("t_from + t_to : "+o+" "+a),loadActiveReport()}),$("#dBtn").click(function(){loadActiveReport()}),$("#nextDate").click(function(){getNextDate()}),$("#prevDate").click(function(){getPrevDate()}),onLoad()});