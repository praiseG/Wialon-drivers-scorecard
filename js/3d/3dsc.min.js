var callbacks={},errorCodes={1:"Invalid session",2:"Invalid service name",3:"Invalid result",4:"Invalid input",5:"Error performing request",6:"Unknown error",7:"Access denied",8:"Invalid user name or password",9:"Authorization server is unavailable",10:"Reached limit of concurrent requests",1001:"No messages for selected interval",1003:"Only one request is allowed at the moment",1004:"Limit of messages has been exceeded",1005:"Execution time has exceeded the limit",1011:"Your IP has changed or session has expired"},timeToSeconds=function(e){if(e){var t=e.split(":");return 3600*+t[0]+60*+t[1]+ +t[2]}},strToDate=function(e,t){if(!e)return null;var o=e.split(".");return t?moment(o[2]+"-"+o[1]+"-"+o[0],"YYYY-MM-DD").endOf("day").format():moment(o[2]+"-"+o[1]+"-"+o[0],"YYYY-MM-DD").startOf("day").format()},showPickerFields=function(){var e=Cookies.getJSON("rDates");console.log(e);var t=moment(e.fDate).format("DD.MM.YYYY"),o=moment(e.tDate).format("DD.MM.YYYY");$("#fromDate").val(t),$("#toDate").val(o),$("#fromDate").datepicker({dateFormat:"dd.mm.yy",maxDate:"+1d"}),$("#toDate").datepicker({dateFormat:"dd.mm.yy",maxDate:"+1d"}),$(".picker-display").hide(),$(".picker-fields").show()},showPickerDisplays=function(e,t){console.log(Cookies.getJSON("rDates")),"wDate"==e||"mDate"==e?$("#selDate").addClass("form-control-sel"):$("#selDate").removeClass("form-control-sel"),$("#selDate").val(t),$(".picker-fields").hide(),$(".picker-display").show()},setCookies=function(e,t){ck=Cookies.get(e),null!=ck&&Cookies.remove(e),Cookies.set(e,t)},getDates=function(e){if(setCookies("period",e),"tDate"==e){var t=moment().startOf("day"),o=moment().endOf("day"),a=t.format("DD.MM.YYYY");setCookies("rDates",{fDate:t.format(),tDate:o.format()}),setCookies("selDates",a),showPickerDisplays(e,a)}else if("yDate"==e){t=moment().subtract(1,"days").startOf("day"),o=moment().subtract(1,"days").endOf("day"),a=t.format("DD.MM.YYYY");setCookies("rDates",{fDate:t.format(),tDate:o.format()}),setCookies("selDates",a),showPickerDisplays(e,a)}else if("wDate"==e){t=moment().subtract(1,"weeks").startOf("week"),o=moment().subtract(1,"weeks").endOf("week"),a=t.format("DD.MM.YYYY")+"-"+o.format("DD.MM.YYYY");setCookies("rDates",{fDate:t.format(),tDate:o.format()}),setCookies("selDates",a),showPickerDisplays(e,a)}else if("mDate"==e){t=moment().subtract(1,"months").startOf("month"),o=moment().subtract(1,"months").endOf("month"),a=t.format("DD.MM.YYYY")+"-"+o.format("DD.MM.YYYY");setCookies("rDates",{fDate:t.format(),tDate:o.format()}),setCookies("selDates",a),showPickerDisplays(e,a)}else"cDate"==e&&(showPickerFields(),Cookies.remove("selDates"))},getNextDate=function(){var e=$("#dTargets label.active"),t=e.children("input").prop("id");if("yDate"==t){var o=Cookies.getJSON("rDates"),a=moment(o.fDate).add(1,"days"),r=moment(o.tDate).add(1,"days"),n=moment().startOf("day"),l=a.format("DD.MM.YYYY");setCookies("rDates",{fDate:a.format(),tDate:r.format()}),setCookies("selDates",l),showPickerDisplays(t,l),console.log("min = today;"+a+"="+n),a.isSame(n)&&(e.removeClass("active"),$("#tDate").parent("label").addClass("active"))}else if("wDate"==t){o=Cookies.getJSON("rDates");var s=moment(o.fDate).add(1,"weeks"),i=moment(o.tDate).add(1,"weeks"),c=moment().endOf("day"),g=moment().startOf("day");if(console.log("tf tt:"+s.format()+" "+i.format()),s.isBefore(g)||s.isSame(g)){a=s,r=i.isAfter(c)?c:i,l=a.format("DD.MM.YYYY")+"-"+r.format("DD.MM.YYYY");setCookies("rDates",{fDate:a.format(),tDate:r.format()}),setCookies("selDates",l),showPickerDisplays(t,l)}}else if("mDate"==t){o=Cookies.getJSON("rDates"),s=moment(o.fDate).add(1,"months").startOf("month"),i=moment(o.tDate).add(1,"months").endOf("month"),c=moment().endOf("day"),g=moment().startOf("day");if(console.log("tf tt:"+s.format()+" "+i.format()),s.isBefore(g)||s.isSame(g)){a=s,r=i.isAfter(c)?c:i,l=a.format("DD.MM.YYYY")+"-"+r.format("DD.MM.YYYY");setCookies("rDates",{fDate:a.format(),tDate:r.format()}),setCookies("selDates",l),showPickerDisplays(t,l)}}console.log(t)},getPrevDate=function(){var e=$("#dTargets label.active"),t=e.children("input").prop("id");if("tDate"==t){var o=moment().subtract(1,"days").startOf("day"),a=moment().subtract(1,"days").endOf("day"),r=o.format("DD.MM.YYYY");setCookies("rDates",{fDate:o.format(),tDate:a.format()}),setCookies("selDates",r),showPickerDisplays(t,r),e.removeClass("active"),$("#yDate").parent("label").addClass("active")}else if("yDate"==t){var n=Cookies.getJSON("rDates");o=moment(n.fDate).subtract(1,"days"),a=moment(n.tDate).subtract(1,"days"),r=o.format("DD.MM.YYYY");setCookies("rDates",{fDate:o.format(),tDate:a.format()}),setCookies("selDates",r),showPickerDisplays(t,r),console.log("min to max "+o+" "+a)}else if("wDate"==t){n=Cookies.getJSON("rDates"),o=moment(n.fDate).subtract(1,"weeks").startOf("week"),a=moment(n.fDate).subtract(1,"weeks").endOf("week"),r=o.format("DD.MM.YYYY")+"-"+a.format("DD.MM.YYYY");setCookies("rDates",{fDate:o.format(),tDate:a.format()}),setCookies("selDates",r),showPickerDisplays(t,r),console.log("min to max "+o+" "+a)}else if("mDate"==t){n=Cookies.getJSON("rDates"),o=moment(n.fDate).subtract(1,"months").startOf("month"),a=moment(n.fDate).subtract(1,"months").endOf("month"),r=o.format("DD.MM.YYYY")+"-"+a.format("DD.MM.YYYY");setCookies("rDates",{fDate:o.format(),tDate:a.format()}),setCookies("selDates",r),showPickerDisplays(t,r),console.log("min to max "+o+" "+a)}console.log(t)},getDateInterval=function(){var e=Cookies.getJSON("rDates");if(!e)return null;var t=moment(e.fDate).unix(),o=moment(e.tDate).unix();return console.log("intervals:fromDate : toDate ="+t+" ===="+o),[t,o]};function ie(){return-1!=navigator.appVersion.indexOf("MSIE 6")||-1!=navigator.appVersion.indexOf("MSIE 7")||-1!=navigator.appVersion.indexOf("MSIE 8")}var execCallback=function(e){callbacks[e]&&callbacks[e].call()};function wrapCallback(e){var t=(new Date).getTime();return callbacks[t]=e,t}function getHtmlVar(e){if(!e)return null;for(var t=decodeURIComponent(document.location.search.substr(1)).split("&"),o=0;o<t.length;o++){var a=t[o].split("=");if(a[0]==e)return a.splice(0,1),a.join("=")}return null}function loadScript(e,t){var o=document.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("charset","UTF-8"),o.setAttribute("src",e),t&&"function"==typeof t&&(wrapCallback(t),ie()?o.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||t()}:o.setAttribute("onLoad","execCallback("+wrapCallback(t)+")")),document.getElementsByTagName("head")[0].appendChild(o)}var getTransporterFromUnitName=function(e){if(e)return start=e.indexOf("("),end=e.indexOf(")"),transporter=e.slice(start+1,end),unit_license=e.slice(0,start),{transporter:transporter,unit_license:unit_license}},fetchUnitsRecur=function(e){var t=wialon.core.Session.getInstance();t.loadLibrary("itemIcon"),t.loadLibrary("itemCustomFields"),t.loadLibrary("itemProfileFields"),t.loadLibrary("unitDriveRankSettings"),t.loadLibrary("unitEvents"),t.loadLibrary("unitTripDetector"),t.loadLibrary("unitSensors");var o=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Unit.dataFlag.lastMessage,wialon.item.Unit.dataFlag.sensors,wialon.item.Item.dataFlag.customFields,wialon.item.Item.dataFlag.adminFields,wialon.item.Item.dataFlag.customProps,wialon.item.Item.dataFlag.guid,256,8388608,131072,524288,8192,4096,1048576);t.updateDataFlags([{type:"type",data:"avl_unit",flags:o,mode:0},{type:"type",data:"avl_unit_group",flags:o,mode:0}],function(o){if(console.log("codefu "+o),o)console.log(wialon.core.Errors.getErrorText(o));else{var a=t.getItems("avl_unit");if((a=wialon.util.Helper.filterItems(a,wialon.item.Item.accessFlag.execReports))&&a.length){console.log("units hereee orig"),console.log(a);var r=$("#vlr-tbl").dataTable().api(),n=[],l="";if(e){var s=t.getItem(e);if(console.log("selected group item "),console.log(s),!s)return void console.log("Selected Unit Groups not found");var i=s.getUnits();s.getName();i.length?(console.log("looping through group units"),_.each(a,function(e,t,o){var a=e.getId();_.contains(i,a)&&n.push(e)})):r.row(0).remove().draw()}else{var c=t.getItems("avl_unit_group");if(console.log("unit Groups"),console.log(c),!c||!c.length)return void console.log("No Unit Groups found");l+='<option class="select-option" id="" selected>All Units</option>',_.each(c,function(e,t,o){var r=e.getName();if("Camera Units"!=r){var s=e.getId();e.getUnits();l+='<option class="select-option" id="'+s+'">'+r+"</option>"}n=a})}if(l&&($("#groups-list").empty(),$("#groups-list").html(l)),n.length){console.log("inside a_u loop");var g=0,d=function(e){if(e<n.length){console.log("inside if1 ");var o=n[e],a=o.getName();if(a.endsWith("(Cam)")||a.endsWith("(Eco Driving)")||a.startsWith("inspector.wiatag"))d(e+1);else{console.log("inside if2 ");var l=o.getMessageParams();console.log("message params==="+a),console.log(l);var s=t.getServerTime(),i=(parseInt(604800,10),"unknown"),c="unknown",m="unknown",u="unknown",p="unknown",f="unknown",v=_.values(o.getCustomFields());_.size(v)>0&&_.each(v,function(e,t,o){"Site Name"==e.n?i=e.v:"Site ID"==e.n&&(c=e.v)});var h=_.values(o.getProfileFields());_.size(h)>0&&_.each(h,function(e,t,o){"year"==e.n?m=e.v:"brand"==e.n?u=e.v:"model"==e.n?p=e.v:"vin"==e.n&&(f=e.v)});var D="unknown",w=o.getPosition();w&&(D=wialon.util.DateTime.formatTime(w.t));var y=getTransporterFromUnitName(a),b=y.transporter,I=y.unit_license,k={id:g++,icon_url:o.getIconUrl(32),transporter_id:b,license_number:I,vin:f,year_mke_model:m+"/"+u+"/"+p,site_name:i,site_id:c,ivms_id:o.getUniqueId(),last_gps_conn:D,last_trip_dt:D},S=_.template($("#vlr-data").html());o.getIgnitionHistory(3,1,s,0,"Ignition",function(t,a){0!=t||"error"in a||console.log("ignition history"+o.getName()),console.log(t,a);var n=a[0];console.log(n),r.row.add($(S({vhl:k}))),0==e?r.row(0).remove().draw():r.draw(),d(e+1)})}}};d(0)}}else console.log("Units not found")}})},fetchUnits=function(e){var t=wialon.core.Session.getInstance();t.loadLibrary("itemIcon"),t.loadLibrary("itemCustomFields"),t.loadLibrary("itemProfileFields"),t.loadLibrary("unitDriveRankSettings"),t.loadLibrary("unitEvents"),t.loadLibrary("unitTripDetector"),t.loadLibrary("unitSensors");var o=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Unit.dataFlag.lastMessage,wialon.item.Unit.dataFlag.sensors,wialon.item.Item.dataFlag.customFields,wialon.item.Item.dataFlag.adminFields,wialon.item.Item.dataFlag.customProps,wialon.item.Item.dataFlag.guid,256,8388608,131072,524288,8192,4096,1048576);t.updateDataFlags([{type:"type",data:"avl_unit",flags:o,mode:0},{type:"type",data:"avl_unit_group",flags:o,mode:0}],function(o){if(console.log("codefu "+o),o)console.log(wialon.core.Errors.getErrorText(o));else{var a=t.getItems("avl_unit");if((a=wialon.util.Helper.filterItems(a,wialon.item.Item.accessFlag.execReports))&&a.length){console.log("units hereee orig"),console.log(a);var r=$("#vlr-tbl").dataTable().api(),n=[],l="";if(e){var s=t.getItem(e);if(console.log("selected group item "),console.log(s),!s)return void console.log("Selected Unit Groups not found");var i=s.getUnits();s.getName();i.length?(console.log("looping through group units"),_.each(a,function(e,t,o){var a=e.getId();_.contains(i,a)&&n.push(e)})):r.row(0).remove().draw()}else{var c=t.getItems("avl_unit_group");if(console.log("unit Groups"),console.log(c),!c||!c.length)return void console.log("No Unit Groups found");l+='<option class="select-option" id="" selected>All Units</option>',_.each(c,function(e,t,o){var r=e.getName();if("Camera Units"!=r){var s=e.getId();e.getUnits();l+='<option class="select-option" id="'+s+'">'+r+"</option>"}n=a})}if(l&&($("#groups-list").empty(),$("#groups-list").html(l)),n.length){for(var g=0,d=0;g<n.length;g++,d++){var m=n[g],u=m.getName();if(u.endsWith("(Cam)")||u.endsWith("(Eco Driving)")||u.startsWith("inspector.wiatag"))d--;else{m.getTripsHistory()&&(console.log("trips history here"),console.log(m.getTripsHistory()),console.log("trips hist here")),m.getCurrentTrip()&&(console.log("trips here"),console.log(m.getCurrentTrip()),console.log("trips here"));var p=t.getServerTime();parseInt(604800,10);(m=n[g]).getIgnitionHistory(3,3,p,0,"Ignition",function(e,t){console.log("ignition history"+m.getName()),console.log(e,t)});var f="unknown",v="unknown",h="unknown",D="unknown",w="unknown",y="unknown",b=_.values(m.getCustomFields());_.size(b)>0&&_.each(b,function(e,t,o){"Site Name"==e.n?f=e.v:"Site ID"==e.n&&(v=e.v)});var I=_.values(m.getProfileFields());_.size(I)>0&&_.each(I,function(e,t,o){"year"==e.n?h=e.v:"brand"==e.n?D=e.v:"model"==e.n?w=e.v:"vin"==e.n&&(y=e.v)});var k="unknown",S=m.getPosition();S&&(k=wialon.util.DateTime.formatTime(S.t));var C=getTransporterFromUnitName(u),F=C.transporter,Y=C.unit_license,T={id:d+1,icon_url:m.getIconUrl(32),transporter_id:F,license_number:Y,vin:y,year_mke_model:h+"/"+D+"/"+w,site_name:f,site_id:v,ivms_id:m.getUniqueId(),last_gps_conn:k,last_trip_dt:k},N=_.template($("#vlr-data").html());r.row.add($(N({vhl:T})))}}r.row(0).remove().draw()}}else console.log("Units not found")}})},fetchDrivers=function(){var e=wialon.core.Session.getInstance();e.loadLibrary("resourceDrivers"),e.loadLibrary("resourceDriverUnits"),e.loadLibrary("itemDriver"),e.loadLibrary("itemCustomFields");var t=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Resource.dataFlag.drivers,wialon.item.Resource.dataFlag.driverUnits,wialon.item.Item.dataFlag.customFields,16384);e.updateDataFlags([{type:"type",data:"avl_resource",flags:t,mode:0},{type:"type",data:"avl_unit",flags:t,mode:0}],function(t){if(t)console.log(wialon.core.Errors.getErrorText(t));else{var o=e.getItems("avl_resource");if(console.log("***************resource heres**********"),console.log(o),console.log("***************resources**********"),o&&o.length){for(var a=$("#dlr-tbl").dataTable().api(),r=0;r<o.length;r++){var n=o[r],l=n.getName(),s=_.values(n.getDrivers());if(console.log("res: "+l),console.log("reports"),_.size(s)>0)for(var i=0;i<s.length;i++){var c=s[i],g=c.n;c.id;console.log("--------dr-------------------"),console.log(c);var d="unknown",m="unknown",u="unknown",p="unknown",f="unknown",v="N/A";if(c.bu){console.log("driver Units");var h=e.getItem(c.bu);v=getTransporterFromUnitName(h.getName()).transporter,console.log(c.bu),console.log(h),console.log("Units after")}var D=c.jp;_.size(D)>0&&(_.has(D,"Site Name")&&(d=D["Site Name"]),_.has(D,"IVMS ID")&&(u=D["IVMS ID"]),_.has(D,"Site ID")&&(m=D["Site ID"]),_.has(D,"License ID")&&(p=D["License ID"]),_.has(D,"License Expiry")&&(f=D["License Expiry"]),console.log("site_name in:"+d)),console.log("site_name out:"+d);var w={id:i+1,icon_url:null,transporter_id:v,name:g,driver_id:u,driver_license:p,site_name:d,site_id:m,license_expiry:f},y=_.template($("#dlr-data").html());a.row.add($(y({drv:w})))}}a.row(0).remove().draw()}else console.log("No Resources found")}})},loadUnitScoreCard=function(e){console.log("score Unit: "+e);var t=JSON.parse(localStorage.getItem("unit_squeue")),o=parseInt(localStorage.getItem("queue-counter")),a=e;if(!a&&t.length&&(a=t[0]),a){var r=wialon.core.Session.getInstance();r.loadLibrary("itemIcon"),r.loadLibrary("itemCustomFields"),r.loadLibrary("itemProfileFields"),r.loadLibrary("unitDriveRankSettings"),r.loadLibrary("unitEvents"),r.loadLibrary("unitTripDetector");var n=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Unit.dataFlag.lastMessage,wialon.item.Item.dataFlag.customFields,wialon.item.Item.dataFlag.adminFields,wialon.item.Item.dataFlag.customProps,wialon.item.Item.dataFlag.guid,256,8388608,131072,524288,8192);r.updateDataFlags([{type:"type",data:"avl_unit",flags:n,mode:0}],function(e){if(console.log("code  "+e),e)console.log(wialon.core.Errors.getErrorText(e));else{var n=r.getItem(a);if(console.log(n),n){var l=$("#dsc-tbl-single").dataTable().api();r.getCurrUser().getAccountId();15452548;var s=getDateInterval(),i=s[1],c=s[0];console.log("t_to :"+i),console.log("t_from :"+c);var g=n.getName(),d=getTransporterFromUnitName(g),m=d.transporter,u=d.unit_license,p=0,f=0,v="unknown",h="unknown",D="00:00:00",w=0,y=0,b=0,I=0,k=0,S=null,C=0,F=_.values(n.getCustomFields());_.size(F)>0&&_.each(F,function(e,t,o){"Site Name"==e.n&&(h=e.v)});var Y=[{svc:"report/exec_report",params:{reportResourceId:15452548,reportTemplateId:48,reportObjectId:a,reportObjectSecId:0,interval:{flags:0,from:c,to:i}}},{svc:"report/select_result_rows",params:{tableIndex:0,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/select_result_rows",params:{tableIndex:1,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/select_result_rows",params:{tableIndex:2,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/cleanup_result",params:{}}];wialon.core.Remote.getInstance().remoteCall("core/batch",Y,function(e,r){if(console.log("code obj: "+e),console.log(r),0===e&&r&&r.length&&!("error"in r[0])&&"reportResult"in r[0]&&r[0].reportResult.tables.length>0){console.log("report successful see obj below"),console.log(r);for(var n=r[0].reportResult.tables,s=0;s<n.length;s++)if("unit_ecodriving"!=n[s].name||"error"in r[s+1])if("unit_speedings"!=n[s].name||"error"in r[s+1]){if("unit_trips"==n[s].name&&!("error"in r[s+1])){var i=n[s].total[0].split(" ");C=i[0],console.log("Total Mileage : "+C)}}else{"unknown"==v&&n[s].total[1]&&(v=n[s].total[1]),D=n[s].total[0];var c=timeToSeconds(D);w=parseInt(c/60),p+=w,console.log("Speeding penalty total "+p)}else{for(var d=r[s+1],F=0;F<d.length;F++){var Y=d[F].c[0].t;"Harsh Acceleration"==Y?(y=d[F].c[3].t,b=d[F].c[2].t,p+=parseInt(b)):"Harsh Braking"==Y&&(I=d[F].c[3].t,k=d[F].c[2].t,p+=parseInt(k)),"unknown"==v&&d[F].c[4].t&&(v=d[F].c[4].t)}console.log("eco driving penalty total "+p)}0<=(f=Math.round(p/C*100))&&f<=2?S="green":2<f&&f<=5?S="yellow":f>5&&(S="red"),console.log("ovs count :"+D),console.log("ovs pnalty :"+w),console.log("hacc count :"+y),console.log("hacc pnalty :"+b),console.log("hbrk count :"+I),console.log("hbrk pnalty :"+k),console.log("total pnalty :"+p),console.log("s_color ;"+S);var T={id:o,uid:a,s_color:S,transporter_id:m,drv_name:v,vehicle_license:u,drv_lic:"unknown",tot_mileage:C.toLocaleString("en"),site_name:h,hbrk_penalty:k,hbrk_occur:I,hacc_penalty:b,hacc_occur:y,ovs_penlty:w.toLocaleString("en"),ovs_duration:D,drvtime_penalty:0,drvtime_mins:0,resting_penalty:0,score:f},N=_.template($("#dsc-data-single").html());l.row.add($(N({dsc:T}))),l.draw(),$("#unit-list").find("#"+a).children(".spinner-3d").hide(),t=_.without(t,a),localStorage.setItem("unit_squeue",JSON.stringify(t)),localStorage.setItem("queue-counter",o+1)}else 0==e&&0==r[0].reportResult.tables.length?($("#unit-list").find("#"+a).children(".spinner-3d").hide(),t=_.without(t,a),localStorage.setItem("unit_squeue",JSON.stringify(t)),new PNotify({text:"No Data Found for Unit"+g,type:"error"})):new PNotify({title:"Oh No",text:errorCodes[e],type:"error"})})}else console.log("Unit not found")}})}},loadGroupScoreCard=function(e,t,o){if(console.log("inside group report"),console.log("res - gid :"+e+" "+t),e&&t&&o){console.log(o),wialon.core.Session.getInstance().loadLibrary("resourceReports");var a=$("#dsc-tbl").dataTable().api(),r=1,n=getDateInterval(),l=n[1],s=n[0];console.log("intervals :"+l+" "+s),console.log("configs here"),console.log(e),console.log(t),console.log(s),console.log(l);var i=[{svc:"report/exec_report",params:{reportResourceId:e,reportTemplateId:49,reportObjectId:t,reportObjectSecId:0,interval:{flags:0,from:s,to:l}}},{svc:"report/select_result_rows",params:{tableIndex:0,config:{type:"range",data:{from:0,to:65535,level:4,rawValues:0}}}},{svc:"report/select_result_rows",params:{tableIndex:1,config:{type:"range",data:{from:0,to:65535,level:4,rawValues:0}}}},{svc:"report/select_result_rows",params:{tableIndex:2,config:{type:"range",data:{from:0,to:65535,level:4,rawValues:0}}}},{svc:"report/cleanup_result",params:{}}];wialon.core.Remote.getInstance().remoteCall("core/batch",i,function(e,t){if(console.log(e),console.log(t),0===e&&t&&t.length&&!("error"in t[0])&&"reportResult"in t[0]&&t[0].reportResult.tables.length>0){console.log("report successful"),console.log(o);for(var n=0;n<o.length;n++){var l,s,i=o[n],c=0,g=0,d="unknown",m="unknown",u="00:00:00",p=0,f=0,v=0,h=0,D=0,w=0,y=null,b=0;uf_name=i.getName();var I=getTransporterFromUnitName(uf_name);s=I.transporter,l=I.unit_license;var k=_.values(i.getCustomFields());_.size(k)>0&&_.each(k,function(e,t,o){"Site Name"==e.n&&(m=e.v)}),r_tables=t[0].reportResult.tables;for(var S=0;S<r_tables.length;S++)if("unit_group_ecodriving"!=r_tables[S].name||"error"in t[S+1])if("unit_group_speedings"!=r_tables[S].name||"error"in t[S+1]){if("unit_group_trips"==r_tables[S].name&&!("error"in t[S+1])){var C=t[S+1];for(Y=0;Y<C.length;Y++){if(C[Y].c[0]==uf_name)b=C[Y].c[1].split(" ")[0],console.log("Total Mileage : "+b),"unknown"==d&&C[Y].c[6]&&(d=C[Y].c[6])}}}else for(var F=t[S+1],Y=0;Y<F.length;Y++)F[Y].c[0]==uf_name&&(console.log("uf_name="+uf_name),u=F[Y].c[1],f=timeToSeconds(u),c+=p=parseInt(f/60),"unknown"==d&&F[Y].c[2]&&(d=F[Y].c[2]));else for(var T=t[S+1],Y=0;Y<T.length;Y++)if(T[Y].c[0]==uf_name){console.log("uf_name="+uf_name);var N=T[Y].r;console.log(N);for(var U=0;U<N.length;U++)"Harsh Acceleration"==N[U].c[1]?(v+=parseInt(N[U].c[2]),h+=parseInt(N[U].c[3]),c+=parseInt(h)):"Harsh Braking"==N[U].c[1]&&(D+=parseInt(N[U].c[2]),w+=parseInt(N[U].c[3]),c+=parseInt(w)),"unknown"==d&&N[U].c[4]&&(d=N[U].c[4])}if((0!=v||0!=D||0!=f)&&0!=b){0<=(g=Math.round(c/b*100))&&g<=2?y="green":2<g&&g<=5?y="yellow":g>5&&(y="red"),console.log("ovs count :"+u),console.log("ovs pnalty :"+p),console.log("hacc count :"+v),console.log("hacc pnalty :"+h),console.log("hbrk count :"+D),console.log("hbrk pnalty :"+w),console.log("total pnalty :"+c);var M={id:r++,s_color:y,transporter_id:s,drv_name:d,drv_lic:"unknown",tot_mileage:b.toLocaleString("en"),vehicle_license:l,site_name:m,hbrk_penalty:w,hbrk_occur:D,hacc_penalty:h,hacc_occur:v,ovs_penlty:p,ovs_duration:u,drvtime_penalty:0,drvtime_mins:0,resting_penalty:0,score:g},x=_.template($("#dsc-data").html());a.row.add($(x({dsc:M})))}}a.row(0).remove().draw()}else alert(errorCodes[e])})}else console.log("no resource or ugidor units")},fetchScores=function(e,t){var o=wialon.core.Session.getInstance(),a=wialon.item.Item.dataFlag.base|wialon.item.Resource.dataFlag.reports,r=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Unit.dataFlag.lastMessage,wialon.item.Item.dataFlag.customFields,wialon.item.Item.dataFlag.adminFields,wialon.item.Item.dataFlag.customProps,wialon.item.Item.dataFlag.guid,256,8388608,131072,524288,8192);o.loadLibrary("resourceReports"),o.loadLibrary("itemCustomFields"),o.loadLibrary("itemProfileFields"),o.updateDataFlags([{type:"type",data:"avl_resource",flags:a,mode:0},{type:"type",data:"avl_unit",flags:r,mode:0},{type:"type",data:"avl_unit_group",flags:r,mode:0}],function(a){if(a)console.log(wialon.core.Errors.getErrorText(a));else{var r,n=o.getItems("avl_resource"),l=o.getItems("avl_unit"),s="",i=null,c=$("#units-tbl").dataTable().api(),g=!1,d=[];if(l&&l.length)if(n&&n.length){if(r=n[0].getId(),console.log("units"),console.log(l),console.log("resources ==here"),console.log(n),console.log("group selected :"+e),console.log("a_units outside group loop"),console.log(d),d=[],e){console.log("a_units inside selected group"),console.log(d);var m=o.getItem(e);if(console.log("selected group item "),console.log(m),!m)return void console.log("Selected Unit Groups not found");i=e;var u=m.getUnits();m.getName();console.log("looping through group units"),_.each(l,function(e,t,o){var a=e.getId();_.contains(u,a)&&d.push(e)})}else{var p=o.getItems("avl_unit_group");if(!p||!p.length)return void console.log("No Unit Groups found");console.log("unit_grps here"),console.log(p),_.each(p,function(e,t,o){var a=e.getName(),r=e.getUnits();if("Camera Units"!=a&&r.length){var n=e.getId();".All Units (LH UG)"==a?(i=n,s+='<option class="select-option" id="'+n+'" selected>'+a+"</option>",_.each(l,function(e,t,o){var a=e.getId();_.contains(r,a)&&d.push(e)})):s+='<option class="select-option" id="'+n+'">'+a+"</option>"}})}s&&($("#groups-list").empty(),$("#groups-list").html(s)),d.length&&!t&&(console.log("loading units html"),_.each(d,function(e,t,o){var a=e.getName();if(!a.endsWith("(Cam)")&&!a.endsWith("(Eco Driving)")&&!a.startsWith("inspector.wiatag")){var r=""+e.getId(),n=_.template($("#u-list-data").html());c.row.add($(n({unt:{uid:r,uname:a}}))),g||(g=!0),c.draw()}}),g&&(c.row(0).remove().draw(),g=!1)),console.log("loding report now"),loadGroupScoreCard(r,i,d)}else console.log("No Resources found");else console.log("No Units found")}})},getDriverScoreFactors=function(){console.log("in Driver Score Card");var e=wialon.core.Session.getInstance();e.loadLibrary("itemIcon"),e.loadLibrary("itemCustomFields"),e.loadLibrary("itemProfileFields"),e.loadLibrary("unitDriveRankSettings"),e.loadLibrary("unitEvents"),e.loadLibrary("unitTripDetector");var t=wialon.util.Number.or(wialon.item.Item.dataFlag.base,wialon.item.Unit.dataFlag.lastMessage,wialon.item.Item.dataFlag.customFields,wialon.item.Item.dataFlag.adminFields,wialon.item.Item.dataFlag.customProps,wialon.item.Item.dataFlag.guid,256,8388608,131072,524288,8192),o=getDateInterval();e.updateDataFlags([{type:"type",data:"avl_unit",flags:t,mode:0}],function(t){if(console.log("codefu "+t),t)console.log(wialon.core.Errors.getErrorText(t));else{var a=e.getItems("avl_unit");if((a=wialon.util.Helper.filterItems(a,wialon.item.Item.accessFlag.execReports))&&a.length){console.log(a);var r=$("#dsc-tbl").dataTable().api();e.getCurrUser().getAccountId();15452548;var n=function(e){if(console.log("inside ca scores"),e<a.length){var t=a[e],l=t.getName();if(console.log("unit ========================="+l),l.endsWith("(Cam)"))n(e+1);else{var s=getTransporterFromUnitName(l),i=s.transporter,c=s.unit_license,g=(t.getMileageCounter(),t.getId()),d=o[1],m=o[0];console.log("t_to :"+d),console.log("t_from :"+m);var u=0,p=0,f="unknown",v="unknown",h="unknown",D="00:00:00",w=0,y=0,b=0,I=0,k=0,S=null,C=0,F=_.values(t.getCustomFields());_.size(F)>0&&_.each(F,function(e,t,o){"Site Name"==e.n?h=e.v:"Driver License ID"==e.n&&(v=e.v)});var Y=[{svc:"report/exec_report",params:{reportResourceId:15452548,reportTemplateId:48,reportObjectId:g,reportObjectSecId:0,interval:{flags:0,from:m,to:d}}},{svc:"report/select_result_rows",params:{tableIndex:0,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/select_result_rows",params:{tableIndex:1,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/select_result_rows",params:{tableIndex:2,config:{type:"range",data:{from:0,to:65535,level:1,rawValues:1}}}},{svc:"report/cleanup_result",params:{}}];wialon.core.Remote.getInstance().remoteCall("core/batch",Y,function(t,o){if(console.log("closure id*******"+e),console.log("code remote: "+t),console.log(o),0===t&&o&&o.length&&!("error"in o[0])&&"reportResult"in o[0]&&o[0].reportResult.tables.length>0){console.log("report successful see obj below"),console.log(o);for(var a=o[0].reportResult.tables,l=0;l<a.length;l++)if("unit_ecodriving"!=a[l].name||"error"in o[l+1])if("unit_speedings"!=a[l].name||"error"in o[l+1]){if("unit_trips"==a[l].name&&!("error"in o[l+1])){var s=a[l].total[0].split(" ");C=s[0],console.log("Total Mileage : "+C)}}else{for(var g=o[l+1],d=0;d<g.length;d++)if("unknown"==f&&g[d].c[1].t){f=g[d].c[1].t;break}D=a[l].total[0];var m=timeToSeconds(D);w+=parseInt(m/60),u+=w,console.log("Speeding penalty total "+u)}else{for(var F=o[l+1],Y=0;Y<F.length;Y++){var T=F[Y].c[0].t;"Harsh Acceleration"==T?(y=F[Y].c[2].t,b=F[Y].c[1].t,u+=parseInt(b)):"Harsh Braking"==T&&(I=F[Y].c[2].t,k=F[Y].c[1].t,u+=parseInt(k)),"unknown"==f&&F[Y].c[3].t&&(f=g[Y].c[3].t)}console.log("eco driving penalty total "+u)}0<=(p=Math.round(u/C*100))&&p<=2?S="green":2<p&&p<=5?S="yellow":p>5&&(S="red"),console.log("ovs count :"+D),console.log("ovs pnalty :"+w),console.log("hacc count :"+y),console.log("hacc pnalty :"+b),console.log("hbrk count :"+I),console.log("hbrk pnalty :"+k),console.log("total pnalty :"+u),console.log("s_color ;"+S);var N={id:e+1,s_color:S,transporter_id:i,drv_name:f,vehicle_license:c,drv_lic:v,tot_mileage:C.toLocaleString("en"),site_name:h,hbrk_penalty:k,hbrk_occur:I,hacc_penalty:b,hacc_occur:y,ovs_penlty:w.toLocaleString("en"),ovs_duration:D,drvtime_penalty:0,drvtime_mins:0,resting_penalty:0,score:p},U=_.template($("#dsc-data").html());r.row.add($(U({dsc:N}))),0==e&&r.row(0).remove(),r.draw()}n(e+1)})}}};n(0)}else console.log("Units not found")}})},vlrReport=function(e){var t=_.template($("#vlr-cols").html());$(".date-displays").hide(),$("#unit-groups").show(),$("#rpt-table, #unit-list, #unit-scores").empty(),$("#rpt-table").html(t),$("#vlr-tbl").DataTable({pageLength:12,language:{emptyTable:"No Units Found",search:"_INPUT_",searchPlaceholder:"Search..."},dom:"Bfrtip",buttons:["csv",{extend:"excelHtml5",title:"Vehicles List Report"},"pdf","print"]}),fetchUnits(e)},dlrReport=function(){var e=_.template($("#dlr-cols").html());$(".date-displays").hide(),$("#unit-groups").hide(),$("#rpt-table, #unit-list, #unit-scores").empty(),$("#rpt-table").html(e),$("#dlr-tbl").DataTable({pageLength:12,dom:"Bfrtip",buttons:["csv",{extend:"excelHtml5",title:"Drivers List Report"},"pdf","print"],language:{search:"_INPUT_",searchPlaceholder:"Search..."}}),fetchDrivers()},dscReport=function(e,t){var o=_.template($("#dsc-cols").html());if($(".date-displays").show(),$(".picker-fields").hide(),$("#unit-groups").show(),$("#rpt-table").empty(),$("#unit-score").empty(),!t){var a=_.template($("#u-list-cols").html());$("#unit-list").empty(),$("#unit-list").html(a),$("#units-tbl").DataTable({scrollY:"350px",scrollCollapse:!0,paging:!1,language:{search:"_INPUT_",searchPlaceholder:"Search..."}})}$("#unit-scores").html(o),$("#dsc-tbl").DataTable({language:{emptyTable:"No data available for selected interval"},dom:"Bfrtip",buttons:["csv",{extend:"excelHtml5",title:"Drivers Score Card"},"pdf","print"],language:{search:"_INPUT_",searchPlaceholder:"Search..."}}),fetchScores(e,t)},loadReportTemplate=function(e){console.log(e),"t-dlr"==e?dlrReport():"t-vlr"==e?vlrReport():"t-dsc"==e&&dscReport()},loadActiveReport=function(){var e=Cookies.get("sTemp"),t=parseInt($("#groups-list").find(":selected").prop("id"));console.log("selected report:"+e),console.log(t),"t-dsc"==e&&dscReport(t,!0)},login=function(e){if(console.log("Code: "+e),e)alert("Login Error");else{var t=wialon.core.Session.getInstance().getCurrUser().getName();document.getElementById("username").innerHTML=t,window.setTimeout(function(){$("#rTemplates").val("Drivers_Score_Card").trigger("change")},2e3),window.onbeforeunload=function(){wialon.core.Session.getInstance().logout()}}},initSdk=function(){console.log("Initializing SDK");var e=getHtmlVar("baseUrl")||getHtmlVar("HostUrl");if(console.log("url: "+e),e){var t=getHtmlVar("user")||"",o=getHtmlVar("sid"),a=getHtmlVar("authHash");wialon.core.Session.getInstance().initSession(e),a?(console.log("logging in with authHash"),wialon.core.Session.getInstance().loginAuthHash(a,login)):(console.log("logging in with sid"),wialon.core.Session.getInstance().duplicate(o,t,!0,login))}},onLoad=function(){loadScript("https://hst-api.wialon.com/wsdk/script/wialon.js",initSdk)};$(document).ready(function(){localStorage.removeItem("unit_squeue"),localStorage.removeItem("queue-counter"),moment.tz.setDefault("Africa/Kampala");var e=$(".active").children("input").prop("id");getDates(e),$("#dTargets label").on("click",function(){var e=$(this).children("input").prop("id");getDates(e)}),$("#rTemplates").change(function(){var e=$(this).find(":selected"),t=e.text(),o=e.prop("id");$("#reportTitle").text(t),setCookies("sTemp",o),loadReportTemplate(o)}),$("#groups-list").change(function(){var e=parseInt($(this).find(":selected").prop("id"));console.log("gid after parse"),console.log(e);var t=$("#rTemplates").find(":selected").prop("value");"Drivers_Score_Card"==t?dscReport(e):"Vehicles_List_Report"==t&&vlrReport(e)}),$("#cusBtn").click(function(){var e=$("#fromDate").val(),t=$("#toDate").val();e&&t||alert("Select fromDate and toDate");var o=strToDate(e),a=strToDate(t,!0);setCookies("rDates",{fDate:o,tDate:a}),console.log("t_from + t_to : "+o+" "+a),loadActiveReport()}),$("#dBtn").click(function(){loadActiveReport()}),$("#nextDate").click(function(){getNextDate()}),$("#prevDate").click(function(){getPrevDate()}),$("#unit-list").on("click",".units-arrow",function(){var e=parseInt($(this).parent("td").prop("id"));if(console.log("selected id:fa-id"+e),$(this).hide(),$(this).siblings("span").show(),!$("#dsc-tbl-single").length){console.log("initialised here"),$("#unit-scores").empty();var t=_.template($("#dsc-cols-single").html());$("#unit-scores").html(t),$("#dsc-tbl-single").DataTable({language:{emptyTable:"Loading Data..",search:"_INPUT_",searchPlaceholder:"Search..."},dom:"Bfrtip",buttons:["csv",{extend:"excelHtml5",title:"Drivers Score Card"},"pdf","print"]})}localStorage.getItem("unit_squeue")||(localStorage.setItem("unit_squeue",JSON.stringify([])),localStorage.setItem("queue-counter",1));var o=JSON.parse(localStorage.getItem("unit_squeue"));o.push(e),localStorage.setItem("unit_squeue",JSON.stringify(o)),console.log("uQueue ====="),console.log(o),1==o.length&&loadUnitScoreCard(e)}),$("#unit-scores").on("click",".remove-u",function(){var e=parseInt($(this).closest("tr").index()),t=parseInt($(this).closest("tr").prop("id")),o=$("#dsc-tbl-single").dataTable().api();console.log("you clicked row id :"+e),void 0!==e&&(o.row(e).remove().draw(),$("#unit-list").find("#"+t).children(".units-arrow").show())}),onLoad()});